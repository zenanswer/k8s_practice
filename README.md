# Deploying a jhipster generated microservices on k8s

<img src="https://kubernetes.io/images/kubernetes-horizontal-color.png" height="32">

<img src="https://avatars1.githubusercontent.com/u/6059488?s=200&v=4" height="32">

# File structure

```text
.
|-- k8s_infrastructure                 # config files for k8s infrastructure
|   |-- calico.v3.9.yaml               # [calico](https://www.projectcalico.org/) using it for the k8s DNS and CLUSTER-IP
|   |-- cephfs                         # [ceph](https://ceph.io/) [cephfs](https://ceph.io/ceph-storage/file-system/)
|   |   |-- ceph-admin-secret.yaml     # admin-secret for mounting cephfs 
|   |   |-- cephfs-pv-01.yaml          #
|   |   `-- cephfs-pv-02.yaml          # two PV for the PVC of jhipster-elasticsearch-data and jhipster-elasticsearch-master
|   |-- k8s-init.yaml                  # default k8s-init file be generated by command "kubeadm config print init-defaults"
|   |-- k8s-init-57.yaml               # nodified init file for using on this k8s infrastructure  
|   |-- metallb.v0.8.1.yaml            # [metallb](https://github.com/danderson/metallb) for k8s load-balancer
|   `-- metallb-layer2-config.yaml     # config file for metallb, designate a EXTERNAL-IP pool.
`-- k8s_jhipster                       # k8s deployment scripts be generated by [jhipster](https://www.jhipster.tech/)
    |-- app1
    |-- app2
    |-- console
    |-- gateway
    |-- kubectl-apply.sh
    |-- namespace.yml
    |-- README.md
    |-- registry
    `-- uaa
```

About the k8s deployment scripts you can find them in my other github repo [jhipster_microservice_practice](https://github.com/zenanswer/jhipster_microservice_practice).

And I have to modify them because of some reasons, and explain them in the following session.

# Modify of k8s_jhipster

Here is a diff log for showing what have I modified.

```text
[root@k8s01 k8s_practice]# diff -r ~/project/k8s/ k8s_jhipster/
Only in /root/project/k8s/: .yo-rc.json
diff -r /root/project/k8s/app1/app1-deployment.yml k8s_jhipster/app1/app1-deployment.yml
34a35,36
>       imagePullSecrets:
>         - name: regcred
diff -r /root/project/k8s/app2/app2-deployment.yml k8s_jhipster/app2/app2-deployment.yml
34a35,36
>       imagePullSecrets:
>         - name: regcred
diff -r /root/project/k8s/console/jhipster-elasticsearch.yml k8s_jhipster/console/jhipster-elasticsearch.yml
28a29,31
>   selector:
>     matchLabels:
>       component: jhipster-elasticsearch
174a178,180
>   selector:
>     matchLabels:
>       component: jhipster-elasticsearch
diff -r /root/project/k8s/gateway/gateway-deployment.yml k8s_jhipster/gateway/gateway-deployment.yml
34a35,36
>       imagePullSecrets:
>         - name: regcred
diff -r /root/project/k8s/registry/jhipster-registry.yml k8s_jhipster/registry/jhipster-registry.yml
33a34
>   type: LoadBalancer
37c38
<   clusterIP: None
---
> #  clusterIP: None
diff -r /root/project/k8s/uaa/uaa-deployment.yml k8s_jhipster/uaa/uaa-deployment.yml
34a35,36
>       imagePullSecrets:
>         - name: regcred
[root@k8s01 k8s_practice]#
```

1. imagePullSecrets: I use [Harbor](https://goharbor.io/) be my docker image registry server. For image push and pull, docker login is necessary. k8s will pull images from this registry when deploy our micro services, so we have to give it a secrets pair for this.
2. selector-matchLabels-component: here are some compatible issues against k8s 1.15, have to modify.
3. LoadBalancer and clusterIP: give a EXTERNAL-IP for jhipster-registry, so we can access it.
